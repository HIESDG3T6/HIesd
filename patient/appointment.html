<!--
author: W3layouts
author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Patient Panel </title>
		<!-- for-mobile-apps -->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		
			<script>
				addEventListener("load", function () {
					setTimeout(hideURLbar, 0);
				}, false);
		
				function hideURLbar() {
					window.scrollTo(0, 1);
				}
			</script>
			
			<!-- css files -->
			<link href="../css/css_slider.css" type="text/css" rel="stylesheet" media="all"><!-- slider css -->
			<link href="../css/bootstrap.css" rel='stylesheet' type='text/css' /><!-- bootstrap css -->
			<link href="../css/style.css" rel='stylesheet' type='text/css' /><!-- custom css -->
			<link href="../css/loading.css" rel='stylesheet' type='text/css' /><!-- loading css -->
			
			
			<!-- //css files -->
			
			<!-- google fonts -->
			<link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
			<link href="//fonts.googleapis.com/css?family=Dosis:200,300,400,500,600,700,800&amp;subset=latin-ext" rel="stylesheet">
			<!-- //google fonts -->

			<script 
			src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
			
			<script
			src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
			integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
			crossorigin="anonymous"></script>
			
			<script src="js/jquerysession.js"></script>
			<script src="js/site.js"></script>
		
			<script 
			src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
			integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
			crossorigin="anonymous"></script>
		

			<!-- session -->
			<script>
				if ($.session.get('userid') == null){
					window.location.replace("./login.html");
				}

				var name = $.session.get('name');
				var teleHandle = $.session.get('teleHandle');
				var patientID = $.session.get('patientID');
				
				// console.log($.session.get('userid'));
				// console.log($.session.get('userid'));
				// console.log($.session.get('name'));
				// console.log($.session.get('teleHandle'));
				console.log($.session.get('patientID'));
			</script>
		
			<!-- CALENDAR -->
			<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
			<link rel="stylesheet" href="/resources/demos/style.css">
			<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
			<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
			<script>
			  $( function() {
				  $( "#appointmentDate" ).datepicker({
					dateFormat: "yy-mm-dd",
					minDate: 0
				  });
				} );
			</script>


			<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.css">
			<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.js"></script>
			<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.js"></script>

			<script>

			function refreshTimePicker(disableTimeList=[["12:00","13:00"]]){
				$('#appointmentTime').timepicker({
					'timeFormat': 'g:ia'})

				$('#appointmentTime').timepicker('option',{
					'scrollDefault': 'now',
					'timeFormat': 'H:i',
					'step' : 60,
					'minTime': '10:00',
					'maxTime' : '18:00',
					'disableTimeRanges': disableTimeList
				});
			}
			</script>

			<script>
				var x = location.href;
				var clinicNotFound = false;

				if (x.search("clinic") > -1) {
					var param = location.href.split('?')[1];
					var entries = param.split('&');
					var clinicField = entries[0];
					var locationField = entries[1];

					var clinicName = decodeURI(clinicField.split('=')[1]);
					var postalCode = decodeURI(locationField.split('=')[1]);
				}

				else {
					clinicNotFound = true;
				}
            
			</script>
			
	</head>
<body>


<!-- top header -->
<div class="header-top">
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<ul class="d-lg-flex header-w3_pvt">
					<li class="mr-lg-3">
						<p id="patientNameHeading"> Welcome! Patient </p>
						
					</li>
				</ul>
			</div>
			
			<div class="col-sm-6 header-right-w3_pvt">
				<ul class="d-lg-flex header-w3_pvt justify-content-lg-end">
					<li class="mr-lg-3"><a class="user" href="logout.html">Logout</a></li>
				</ul>
			</div>
		</div>
	</div>
	<script>
			$('#patientNameHeading').append(name);	
	</script>
</div>
<!-- //top header -->

<!-- //header -->
<header class="py-3">
	<div class="container">
			<div id="logo">
				<h1> <a href="index.html"><span class="fa fa-stethoscope" aria-hidden="true"></span> Health Insurance </a></h1>
			</div>
		<!-- nav -->
		<nav class="d-lg-flex">

			<label for="drop" class="toggle"><span class="fa fa-bars"></span></label>
			<input type="checkbox" id="drop" />
			<ul class="menu mt-2 ml-auto">
				<li class=""><a href="precheck.html">Symptoms Checker</a></li>
				<li class=""><a href="search.php">Search Clinics </a></li>
				<li class=""><a href="patient_history.html">Medical History</a></li>
				<li class=""><a href="account.html">Appointment Details</a></li>
			</ul>
			<div class="login-icon ml-2">
				<a class="user" href="appointment.html"> Book Appointment Now</a>
			</div>
		</nav>
		<div class="clear"></div>
		<!-- //nav -->
</header>
<!-- //header -->

<!-- single -->
<section class="bottom-banner-w3layouts py-5">
	<br><br>
	<div class="container py-md-3">
		<h2 class="heading text-center mb-sm-5 mb-4" id="clinicFieldName">Make Appointment for </h2>
		<!-- TO BE DYNAMICALLY RETRIEVED AND UPDATED -->
	</div>

<!-- Appointment Form -->
<div>
		<div id="appointmentSubmission" class="container">
				<form id="appointmentForm">
					
					Appointment Date <input name="appointmentDate" type="text" id="appointmentDate" class="form-control" onchange=showDate() required><br>
					Appointment Time <input name="appointmentTime" type="text" id="appointmentTime" class="form-control" required><br>

					<div>
						Send me a confirmation through: <br> 
					<label><input type="checkbox" name="emailChecked" id="emailChecked" class="form-control"> Email </label>
					<label><input type="checkbox" name="teleChecked" id="teleChecked" class="form-control" onclick=checkSubscribed()> Telegram </label></div>
		
					<button id="bookButton" type="button" class="form-control"> Book </button>
					<p id='plsStart' align='center'> Please start the Telegram Bot to receive Notification </p>
				</form>
			</div>
			
			<script>
				if (clinicNotFound) {
					$('#appointmentForm').prepend('Clinic  <select id="clinicList" name="clinicName" onchange=updateName() required><option></option></select><br><br>')
					getAllClinic();
				}

				async function getAllClinic() {
					var getAllClinicLink = "http://localhost:5111/clinic";

					const getAllClinicResponse = await fetch(getAllClinicLink, { method: 'GET' });
					const clinics = await getAllClinicResponse.json();
					// console.log(clinics);
					var listOfClinic = clinics['clinic'];

					for (clinic in listOfClinic) {
						clinicName = listOfClinic[clinic]['clinicName'];
						
						text = "<option value='" + clinicName + "'>" + clinicName + "</option>";
						$('#clinicList').append(text)
					}
				}

				function updateName() {
					clinicName = $('#clinicList').val();
					var headingText = "Make Appointment for " + clinicName;
					$('#clinicFieldName').text(headingText);
				}


				$('#plsStart').hide();

				$('#clinicFieldName').append(clinicName);

				var getChatID = "http://localhost:5566/telegramNotification/getChatID/" + teleHandle ;
				var sendToChat = "http://localhost:5566/telegramNotification/" + teleHandle;
				var getUpdatesLink = "http://localhost:5566/telegramNotification/update";
				var submitButton = document.getElementById("bookButton");
				var teleStarted = false;
				var teleNeeded = false;
				


				// Show Loading
				function loading() {

					$('#appointmentForm').hide();
					$('#clinicFieldName').hide();

					text = "<div class='wrapper'><div class='circle'></div><div class='circle'></div><div class='circle'></div><div class='shadow'></div><div class='shadow'></div><div class='shadow'></div><span>Loading</span></div>";

					$('#appointmentSubmission').append(text);

				}
	
				// Show Error Message
				function showError(message) {

					$('#appointmentForm').hide();
		
					$('#appointmentSubmission').append("<label>" + message + "</label>");
		
				}
				
				// Dynamically leave out timing that the clinic is not available
				async function showDate() {
					var tempDate = $("#appointmentDate").val();

					var numOfAppointmentLink= "http://localhost:4444/numOfAppointment/";
					numOfAppointmentLink += clinicName + "/" + tempDate;

					const response = await fetch (numOfAppointmentLink, 
										{
											method:'GET'
											// "Access-Control-Allow-Origin" : "*", "Access-Control-Allow-Credentials" : true 
										}
									);
						

						var data = await response.json();

						var disableTimeListNew = [['12:00', '13:00']];

						var appointments = data['appointments'];


						for (index in appointments) {
							var timeslot = appointments[index].appointmentTime;
							var nexthour = Number(timeslot.split(":")[0]) + 1;
							var nextTiming = String(nexthour) + ":00";

							disableTimeListNew.push([timeslot, nextTiming])

						}
						
						refreshTimePicker(disableTimeListNew);

				}

				// ADD BOOK TO DATABASE
				$('#bookButton').click(async(event) => {
		
					event.preventDefault();
		
					var addAppointmentURL = "http://localhost:4444/appointment"
					var mailURL = "http://localhost:5000/appointmentemail"
					
					var customerID = patientID;
					var customername = name;
					var clinicID = clinicName;
					var doctorID = 1;
					var chatID = null;
					var appointmentDate = $('#appointmentDate').val();
					var appointmentTime = $('#appointmentTime').val();
					if (document.getElementById('emailChecked').checked) {
						// console.log("emailChecked");
						// Call for Email Notification API
					}
		
					try {
						const response = await fetch (addAppointmentURL,
							{
								method: 'POST',
								headers: {"Content-Type": "application/json"},
								body: JSON.stringify ({
									customerID: customerID, clinicID : clinicID, doctorID : doctorID, 
									appointmentDate : appointmentDate, appointmentTime : appointmentTime
									})
							},
						);

						
						const data = await response.json();
		
						if (!response.ok) {
							var msg = data['message'];
							showError(msg);

							// Send Telegram Message
							if (document.getElementById('teleChecked').checked) {
								sendToChat += "/" + msg;							
								fetch(sendToChat);
							}


						} else {
							// send an email notifying patient of successful appointment
							if (document.getElementById('emailChecked').checked) {
								try {
        							const mailresponse = await fetch (mailURL,
										{
											method: 'POST',
											headers: {"Content-Type": "application/json"},
											body: JSON.stringify ({
												customerID: name, clinicID : clinicID, doctorID : doctorID, 
												appointmentDate : appointmentDate, appointmentTime : appointmentTime
												})
										}     
        							);

        							const maildata = await mailresponse.json();

        							if (!response.ok) {
										var msg = maildata['message'];
										showError(msg);
        							} 
								} catch (error){
										// console.log(error);
								} 
							}

							// Send Telegram Message
							if (document.getElementById('teleChecked').checked) {
								sendToChat += "/" + appointmentDate + "/" + appointmentTime + "/" + clinicName;
								loading();
								fetch(sendToChat).then( response => {
									location.replace("account.html");
								}
								);
							}

							else {
								location.replace("account.html");
							}
							
						}
					} catch (error) {
						showError ('There is a problem adding the appointment, please try again later.');
					}
				});

				// Get the user chatID
				var fetchNow = function() {
					fetch(getUpdatesLink);
					fetch(getChatID).then( function(response) {
						response.json().then (data => {
							if (data['status'] == true) {
								teleStarted = true;
								alert("Thank you! You will now receive notification from the bot.")
								$("#bookButton").show();
								$("#plsStart").hide();
							}

							else {
								alert("Please start the Telegram Bot. Press Ok when you are done.");
							}

						})
					})

					setTimeout(function(){
						if (teleStarted == false && teleNeeded == true) {
								fetchNow();
						}
						}, 5000
					)
						
				}
				
				// Check if the patient has Start the telebot
				async function checkSubscribed() {
					if (document.getElementById('teleChecked').checked) {
						teleNeeded = true;
						fetch(getChatID).then(function(response) {
							response.json().then (data => {

								if (data['status'] != true) {
									$("#bookButton").hide();
									$("#plsStart").show();
									startBotLink = "https://telegram.me/HIesd_bot?start=check-this-out";
									var win = window.open(startBotLink, '_blank');
									win.focus();
									fetchNow();
								}
							})
						})
					}

					else {
						teleNeeded = false;
						$("#bookButton").show();
						$('#plsStart').hide();
					}
				}
			
			</script>
</div>
</section>	

<!-- copyright -->
<div class="copyright">
	<div class="container py-4">
		<div class=" text-center">
			<p>© 2020 Health Insurance Inc. All Rights Reserved </a> </p>
		</div>
	</div>
</div>
<!-- //copyright -->
		
<!-- move top -->
<div class="move-top text-right">
	<a href="#home" class="move-top"> 
		<span class="fa fa-angle-up  mb-3" aria-hidden="true"></span>
	</a>
</div>
<!-- move top -->


</body>
</html>

<!-- var testNow = function() {
	console.log("hello");
	setTimeout(
		function() {
			if (true) {
				testNow();
			}
		}, 5000)
	console.log(Date.now())
} -->