<!--
author: W3layouts
author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Patient Panel </title>
		<!-- for-mobile-apps -->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		
			<script>
				addEventListener("load", function () {
					setTimeout(hideURLbar, 0);
				}, false);
		
				function hideURLbar() {
					window.scrollTo(0, 1);
				}
			</script>
			
			<!-- css files -->
			<link href="../css/css_slider.css" type="text/css" rel="stylesheet" media="all"><!-- slider css -->
			<link href="../css/bootstrap.css" rel='stylesheet' type='text/css' /><!-- bootstrap css -->
			<link href="../css/style.css" rel='stylesheet' type='text/css' /><!-- custom css -->
			
			<!-- //css files -->
			
			<!-- google fonts -->
			<link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
			<link href="//fonts.googleapis.com/css?family=Dosis:200,300,400,500,600,700,800&amp;subset=latin-ext" rel="stylesheet">
			<!-- //google fonts -->

			<script 
			src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
			
			<script
			src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
			integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
			crossorigin="anonymous"></script>
			
			<script 
			src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
			integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
			crossorigin="anonymous"></script>
		
			<!-- CALENDAR -->
			<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
			<link rel="stylesheet" href="/resources/demos/style.css">
			<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
			<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
			<script>
			  $( function() {
				  $( "#appointmentDate" ).datepicker({
					dateFormat: "yy-mm-dd",
					minDate: 0
				  });
				} );
			</script>


			<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.css">
			<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.js"></script>
			<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.js"></script>
			
			<script>

			function refreshTimePicker(disableTimeList=[["12:00","13:00"]]){
				console.log(disableTimeList);
				$('#appointmentTime').timepicker({
					'timeFormat': 'g:ia'})

				$('#appointmentTime').timepicker('option',{
					'scrollDefault': 'now',
					'timeFormat': 'H:i',
					'step' : 60,
					'minTime': '10:00',
					'maxTime' : '18:00',
					'disableTimeRanges': disableTimeList
				});
			}
			</script>

			<script>
				var x = location.href;
            
            
            	var param = location.href.split('?')[1];
				var entries = param.split('&');
            	var clinicField = entries[0];
            	var locationField = entries[1];

				var clinicName = decodeURI(clinicField.split('=')[1]);
           	 	var postalCode = decodeURI(locationField.split('=')[1]);

				

			
			</script>
			
	</head>
<body>
<!-- update the version number as needed -->
<!-- <script  src="/__/firebase/7.12.0/firebase-app.js"></script> -->
<!-- include only the Firebase features as you need -->
<!-- <script  src="/__/firebase/7.12.0/firebase-auth.js"></script>
<script  src="/__/firebase/7.12.0/firebase-database.js"></script>
<script  src="/__/firebase/7.12.0/firebase-messaging.js"></script>
<script  src="/__/firebase/7.12.0/firebase-storage.js"></script> -->
<!-- initialize the SDK after all desired features are loaded -->
<!-- <script>
	// Your web app's Firebase configuration
	var firebaseConfig = {
	  apiKey: "AIzaSyDv6Gp9lUVuCDWX80uh3eLIninJwrJ6zEA",
	  authDomain: "health-service-2680a.firebaseapp.com",
	  databaseURL: "https://health-service-2680a.firebaseio.com",
	  projectId: "health-service-2680a",
	  storageBucket: "health-service-2680a.appspot.com",
	  messagingSenderId: "565226908168",
	  appId: "1:565226908168:web:869d5bdebf588272f4ffbd",
	  measurementId: "G-LTX07QZ209"
	};
	// Initialize Firebase
	firebase.initializeApp(firebaseConfig);
  </script>

<script>

	// [START get_messaging_object]
	// Retrieve Firebase Messaging object.
	const messaging = firebase.messaging();
	var database = firebase.database();
	// [END get_messaging_object]
	// [START set_public_vapid_key]
	// Add the public key generated from the console here.
	messaging.usePublicVapidKey('BK48hV4s0LbqRJZKWCWhtTySZLS_vIYAnkC4EtCr3kdrEFGdK8mkgmWHhGQjZHbPCOhek2HkoBUrBYwd4_Ts-ho');
	// [END set_public_vapid_key]
  
	messaging.onTokenRefresh(() => {
		messaging.getToken().then((refreshedToken) => {
			console.log('Token refreshed.');
			// Indicate that the new Instance ID token has not yet been sent to the
			// app server.
			setTokenSentToServer(false);
			// Send Instance ID token to app server.
			sendTokenToServer(refreshedToken);
			// [START_EXCLUDE]
			// Display new Instance ID token and clear UI of all previous messages.
			resetUI();
			// [END_EXCLUDE]
		}).catch((err) => {
			console.log('Unable to retrieve refreshed token ', err);
			showToken('Unable to retrieve refreshed token ', err);
		});
  	});
  	// [END refresh_token]

   // [START receive_message]
  // Handle incoming messages. Called when:
  // - a message is received while the app has focus
  // - the user clicks on an app notification created by a service worker
  //   `messaging.setBackgroundMessageHandler` handler.
  messaging.onMessage((payload) => {
    console.log('Message received. ', payload);
    // [START_EXCLUDE]
    // Update the UI to include the received message.
    appendMessage(payload);
    // [END_EXCLUDE]
  });
  // [END receive_message]

	// Get Instance ID token. Initially this makes a network call, once retrieved
	// subsequent calls to getToken will return from cache.
	messaging.getToken().then((currentToken) => {
	if (currentToken) {
		sendTokenToServer(currentToken);
	} else {
		// Show permission request.
		console.log('No Instance ID token available. Request permission to generate one.');
		// Show permission UI.
		setTokenSentToServer(false);

	}
	}).catch((err) => {
		console.log('An error occurred while retrieving token. ', err);
		showToken('Error retrieving Instance ID token. ', err);
		setTokenSentToServer(false);
	});

	function showToken(currentToken) {
		// Show token in console and UI.
		const tokenElement = document.querySelector('#token');
		tokenElement.textContent = currentToken;
  	}

	function sendTokenToServer(currentToken) {
	    // if (!isTokenSentToServer()) {
			console.log('Sending token to server...');
			console.log(currentToken);
			// TODO(developer): Send the current token to your server.
			firebase.database().ref("/tokens").push({
				token: currentToken,
				uid: "receptionist"
			});
		// } else {
		// 	console.log('Token already sent to server so won\'t send it again ' +
		// 		'unless it changes');
		// }

	  }
	  
	function isTokenSentToServer() {
		return firebase.database.ref("/tokens").orderByChild("uid").equalTo("patient");
	}

	function setTokenSentToServer(sent) {
		window.localStorage.setItem('sentToServer', sent ? '1' : '0');
	}


	// Callback fired if Instance ID token is updated.
	messaging.onTokenRefresh(() => {
	messaging.getToken().then((refreshedToken) => {
		console.log('Token refreshed.');

		// Send Instance ID token to app server.
		sendTokenToServer(refreshedToken);
		// ...
	}).catch((err) => {
		console.log('Unable to retrieve refreshed token ', err);
		showToken('Unable to retrieve refreshed token ', err);
	});
	});



</script> -->

<!-- top header -->
<div class="header-top">
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<ul class="d-lg-flex header-w3_pvt">
					<li class="mr-lg-3">
						<p> Welcome! Patient Wong</p>
						
					</li>
					<!-- <li>
						<span class="fa fa-phone"></span>
						<p class="d-inline">Call Us +12 345 678</p>
					</li> -->
				</ul>
			</div>
			<!-- <div class="col-sm-6 header-right-w3_pvt">
				<ul class="d-lg-flex header-w3_pvt justify-content-lg-end">
					<li class="mr-lg-3">
						<span class=""><span class="fa fa-clock-o"></span>Mon - Fri : 8:30am to 9:30pm</span>
					</li>
					<li class="">
						<span class=""><span class="fa fa-clock-o"></span>Sat & Sun : 9:00am to 6:00pm</span>
					</li>
				</ul>
			</div> -->
		</div>
	</div>
</div>
<!-- //top header -->

<!-- //header -->
<header class="py-3">
	<div class="container">
			<div id="logo">
				<h1> <a href="index.html"><span class="fa fa-stethoscope" aria-hidden="true"></span> Health Insurance </a></h1>
			</div>
		<!-- nav -->
		<nav class="d-lg-flex">

			<label for="drop" class="toggle"><span class="fa fa-bars"></span></label>
			<input type="checkbox" id="drop" />
			<ul class="menu mt-2 ml-auto">
				<li class="active"><a href="index.html">Home</a></li>
				<li class=""><a href="precheck.html">PreCheck</a></li>
				<li class=""><a href="search.php">Search Clinics </a></li>
				<li class=""><a href="patient_history.html">Patient History</a></li>
			<!-- 	<li class=""><a href="billing.html">Billing</a></li>-->
				<li class=""><a href="account.html">Account Details</a></li>
			</ul>
			<div class="login-icon ml-2">
				<a class="user" href="appointment.html"> Book Appointment Now</a>
			</div>
		</nav>
		<div class="clear"></div>
		<!-- //nav -->
</header>
<!-- //header -->

<!-- banner -->
<div class="innerpage-banner" id="home">
	<div class="inner-page-layer">
	</div>
</div>
<!-- //banner -->

<!-- single -->
<section class="bottom-banner-w3layouts py-5">
	<div class="container py-md-3">
		<h2 class="heading text-center mb-sm-5 mb-4" id="clinicFieldName">Make Appointment for </h2>
		<!-- TO BE DYNAMICALLY RETRIEVED AND UPDATED -->
	</div>

<!-- Appointment Form -->
<div>
		<div id="appointmentSubmission" class="container">
				<form id="appointmentForm">
					appointmentDate <input name="appointmentDate" type="text" id="appointmentDate" class="form-control" onchange=showDate() required><br>
					appointmentTime <input name="appointmentTime" type="text" id="appointmentTime" class="form-control" required><br>
		
					<button id="bookButton" type="button" class="form-control"> Book </button>
				</form>
			</div>
			
			<script>
				// $("#bookButton").click( function(e){
				// 	e.preventDefault();

				// 	const appointmentdate = document.getElementById('appointmentDate').value; 
				// 	const appointmenttime = document.getElementById('appointmentTime').value; 
				// 	serviceURL = "https://fcm.googleapis.com/v1/{parent=projects/health-service-2680a}/messages:send"


				// 	firebase.database().ref("/notifications").push({
				// 		user: "jiamin",
				// 		date: appointmentdate,
				// 		time: appointmenttime,
				// 	});
				// })

				$('#clinicFieldName').append(clinicName);
				

				function showError(message) {

					$('#appointmentForm').hide()
		
					$('#appointmentSubmission').append("<label>" + message + "</label>");
		
				}
				
				async function showDate() {
					var tempDate = $("#appointmentDate").val();

					var numOfAppointmentLink= "http://localhost:4444/numOfAppointment/";
					numOfAppointmentLink += clinicName + "/" + tempDate;

					const response = await fetch (numOfAppointmentLink, 
										{
											method:'GET', "Access-Control-Allow-Origin" : "*", "Access-Control-Allow-Credentials" : true 
										}
									);
						

						var data = await response.json();

						var disableTimeListNew = [['12:00', '13:00']];

						var appointments = data['appointments'];


						for (index in appointments) {
							var timeslot = appointments[index].appointmentTime;
							var nexthour = Number(timeslot.split(":")[0]) + 1;
							var nextTiming = String(nexthour) + ":00";

							disableTimeListNew.push([timeslot, nextTiming])

						}

						// console.log(disableTimeListNew);
						
						refreshTimePicker(disableTimeListNew);

				};
		
				$('#bookButton').click(async(event) => {
		
					event.preventDefault();
		
					var addAppointmentURL = "http://localhost:4444/appointment"
					// var mailURL = "http://localhost:5000/appointmentemail"

					// var customerID = $('#customerID').val();
					// var clinicID = $('#clinicID').val();
					// var doctorID = $('#doctorID').val();
					var customerID = "jiamin";
					var clinicID = clinicName;
					var doctorID = 1;
					var appointmentDate = $('#appointmentDate').val();
					var appointmentTime = $('#appointmentTime').val();
		
					try {
						const response = await fetch (addAppointmentURL,
							{
								method: 'POST',
								// mode: 'no-cors',
								headers: {"Content-Type": "application/json"},
								body: JSON.stringify ({
									customerID: customerID, clinicID : clinicID, doctorID : doctorID, 
									appointmentDate : appointmentDate, appointmentTime : appointmentTime
									})
							},
						);

						
						const data = await response;

						console.log(data);
						
		
						if (!response.ok) {
							var temp = response.json();
							console.log(temp);
							var msg = data['message'];
							console.log(msg);
							showError(msg);
		
						} else {
							// send an email notifying patient of successful appointment
							// try {
							// 	const mailresponse = await fetch (mailURL,
							// 		{
							// 			method: 'POST',
							// 			mode: 'no-cors',
							// 			headers: {"Content-Type": "application/json"},
							// 			body: JSON.stringify ({
							// 				customerID: customerID, clinicID : clinicID, doctorID : doctorID, 
							// 				appointmentDate : appointmentDate, appointmentTime : appointmentTime
							// 				})
							// 		}
				
									
							// 	);
			
								const maildata = await mailresponse.json();

								if (!response.ok) {
								var msg = maildata['message'];
								showError(msg);
								} 
							} catch (error){
									console.log(error);
							} 
							location.replace("account.html");
						
						
						}
					} catch (error) {
						showError ('There is a problem adding the appointment, please try again later.');
					}
				});
			</script>
</div>
</section>	


<!-- footer -->
<footer class="py-5">
	<div class="container py-sm-3">
		<div class="row footer-grids">
			<div class="col-lg-3 col-sm-6 mb-lg-0 mb-sm-5 mb-4">
				<h4 class="mb-sm-4 mb-3"><span class="fa fa-stethoscope"></span> Health Insurance</h4>
				<p class="mb-3">Onec Consequat sapien ut cursus rhoncus. Nullam dui mi, vulputate ac metus semper quis luctus sed.</p>
				<h5>Trusted by <span>500+ People</span> </h5>
			</div>
			<div class="col-lg-3 col-sm-6 mb-lg-0 mb-sm-5 mb-4">
				<h4 class="mb-sm-4 mb-3">Address Info</h4>
				<p><span class="fa mr-2 fa-map-marker"></span>64d canal street TT 3356 <span>Newyork, NY.</span></p>
				<p class="phone py-2"><span class="fa mr-2 fa-phone"></span> +1(12) 123 456 789 </p>
				<p><span class="fa mr-2 fa-envelope"></span><a href="mailto:info@example.com">info@example.com</a></p>
			</div>
			<div class="col-lg-2 col-sm-6 mb-sm-0 mb-4">
				<h4 class="mb-sm-4 mb-3">Quick Links</h4>
				<ul>
					<li><a href="#">Terms & Conditions</a></li>
					<li class="my-2"><a href="#">Support Helpline</a></li>
					<li><a href="#">Healthy Tips</a></li>
					<li class="mt-2"><a href="#">Privacy Ploicy</a></li>
				</ul>
			</div>
			<div class="col-lg-4 col-sm-6">
				<h4 class="mb-sm-4 mb-3">Subscribe Us</h4>
				<p class="mb-3">Subscribe to our newsletter</p>
				<form action="#" method="post" class="d-flex">
					<input type="email" id="email" name="EMAIL" placeholder="Enter your email here" required="">
					<button type="submit" class="btn">Subscribe</button>
				</form>
				<div class="icon-social mt-3">
					<a href="#" class="button-footr">
						<span class="fa mx-2 fa-facebook"></span>
					</a>
					<a href="#" class="button-footr">
						<span class="fa mx-2 fa-twitter"></span>
					</a>
					<a href="#" class="button-footr">
						<span class="fa mx-2 fa-dribbble"></span>
					</a>
					<a href="#" class="button-footr">
						<span class="fa mx-2 fa-pinterest"></span>
					</a>
					<a href="#" class="button-footr">
						<span class="fa mx-2 fa-google-plus"></span>
					</a>

				</div>
			</div>
		</div>
	</div>
</footer>
<!-- //footer -->

<!-- copyright -->
<div class="copyright">
	<div class="container py-4">
		<div class=" text-center">
			<p>© 2020 Health Insurance Inc. All Rights Reserved </a> </p>
		</div>
	</div>
</div>
<!-- //copyright -->
		
<!-- move top -->
<div class="move-top text-right">
	<a href="#home" class="move-top"> 
		<span class="fa fa-angle-up  mb-3" aria-hidden="true"></span>
	</a>
</div>
<!-- move top -->


</body>
</html>