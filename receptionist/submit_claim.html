<!--
author: W3layouts
author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Submit Claim </title>
		<!-- for-mobile-apps -->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		
			<script>
				addEventListener("load", function () {
					setTimeout(hideURLbar, 0);
				}, false);
		
				function hideURLbar() {
					window.scrollTo(0, 1);
				}
			</script>
			
			<!-- css files -->
			<link href="../css/css_slider.css" type="text/css" rel="stylesheet" media="all"><!-- slider css -->
			<link href="../css/bootstrap.css" rel='stylesheet' type='text/css' /><!-- bootstrap css -->
			<link href="../css/style.css" rel='stylesheet' type='text/css' /><!-- custom css -->

			<!-- //css files -->
			
			<!-- google fonts -->
			<link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
			<link href="//fonts.googleapis.com/css?family=Dosis:200,300,400,500,600,700,800&amp;subset=latin-ext" rel="stylesheet">
			<!-- //google fonts -->
			
			<!-- jquery-->
			<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<meta http-equiv="X-UA-Compatible" content="ie=edge">
			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
			<!-- <script src="js/jquery.min.js"></script> -->
			<!-- //jquery-->
		</head>
<body>

<!-- top header -->
<div class="header-top">
	<div class="container">
		<div class="row">
			<!-- <div class="col-sm-6"> -->
				<ul class="d-lg-flex header-w3_pvt">
					<li class="mr-lg-3">
						<p> Welcome, Receptionist 1</p>
					</li>
				</ul>
		</div>
	</div>
</div>
<!-- //top header -->


<!-- //header -->
<header class="py-3">
	<div class="container">
			<div id="logo">
				<h1> <a href="main.html"><span class="fa fa-stethoscope" aria-hidden="true"></span> Health Insurance </a></h1>
			</div>
		<!-- nav -->
		<!-- <div class="clear"></div> -->
		<!-- //nav -->
	</div>
</header>
<!-- //header -->



<!-- contact -->
<section class="mail pt-lg-5 pt-4">
	<div class="container pt-lg-5">
		<h2 class="heading text-center mb-sm-5 mb-4">Claim Information </h2>
		<!-- <div class="row agileinfo_mail_grids"  >
			<div class="col-lg-8 agileinfo_mail_grid_right"> -->
				<form action="#" method="post" id="info_form">
					<div class="row" >
						<div class="col-md-6 wthree_contact_left">
							<div class="form-group">
								Patient ID<br>
								<input type="text" id="pid" name="pid" class="form-control" placeholder="Patient ID" required="" disabled>
							</div>
							<!-- <div class="form-group">
								Claim ID<br>
								<input type="text" id="claim_id" name="claim_id" class="form-control" placeholder="Claim ID" required="">
							</div> -->
							<div class="form-group">
								Claim Date<br>
								<input type="text" id="claim_date" name="claim_date" class="form-control" placeholder="Claim Date" required="">
                            </div>
                            <div class="form-group">
								Medication<br>
								<input type="text" id="medication" name="medication" class="form-control" placeholder="Medication" required="">
                            </div>
                            <div class="form-group">
								Claim Amount<br>
								<input type="text" id="claim_amt" name="claim_amt" class="form-control" placeholder="Claim Amount" required="">
							</div>
						</div>
						<div class="col-md-6 wthree_contact_left_grid">
							<div class="form-group">
								Appointment ID<br>
								<input type="text" id="aid" name="aid" class="form-control" placeholder="Appointment ID" value="" required="" disabled>
							</div>
							<div class="form-group">
								Clinic ID<br>
								<input type="text" id="clinic_id" name="clinic_id" class="form-control" placeholder="Clinic ID" value="" required="" disabled>
							</div>
							<!-- <div class="form-group">
								<input type="text" id="patient_id" name="patient_id" class="form-control" placeholder="Patient ID" required="">
                            </div> -->
                            <div class="form-group">
								Bill Amount<br>
								<input type="text" id="bill_amt" name="bill_amt" class="form-control" placeholder="Bill Amount" required="">
                            </div>
                            <div class="form-group">
								Claim Status<br>
								<input type="text" id="claim_status" name="claim_status" class="form-control" value = "Open" required="" disabled>
							</div>
                        </div>
						<div class="col-md-12">
							<div class="submit-buttons" style="text-align: center;">
								<button type="submit" class="btn btn-banner my-sm-3 mb-3" name="claim" id="submitClaim">Submit a New Claim</button>

								<!-- <button type="submit" class="btn btn-banner1 my-sm-3 mb-3" name="history">Submit a New Patient Record</button> -->
                            </div>
                            <div class="col-md-12">
                            </div>
						</div>
					</div>
                </form>
                <div class="container pt-lg-5">
                </div>
		</div>

</section>


<!-- copyright -->
<div class="copyright">
	<div class="container py-4">
		<div class=" text-center">
			<p>Â© 2020 Health Insurance Inc. All Rights Reserved </a> </p>
		</div>
	</div>
</div>
<!-- //copyright -->
		
<!-- move top -->
<div class="move-top text-right">
	<a href="#home" class="move-top"> 
		<span class="fa fa-angle-up  mb-3" aria-hidden="true"></span>
	</a>
</div>
<!-- move top -->

</body>

<!-- send message to Claim MS and PH MS -->
<script>
// Helper function to display error message
	function getvalue(name){
				var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return r[2]; return '';
			}

	function showError(message) {
			// Display an error under the the predefined label with error as the id
			$('#main-container')
					.append("<label>"+message+"</label>");
		}
	
	//Get form data
		// PID and Clinic ID passed through URL 
		var PID = getvalue('pid');
		var ClinicID = getvalue('clinicid');
		var AID = getvalue('aid');

		//set the value to the textinput from URL
		$("#clinic_id").val(ClinicID);
		$("#pid").val(PID);
		$("#aid").val(AID);

		// set date as current
		var now = new Date();
		var day = ('0'+now.getDate()).slice(-2);
		var month = ('0' + (now.getMonth()+1)).slice(-2);
		var today = now.getFullYear()+'-'+(month)+'-'+(day);
		$("#claim_date").val(today);

	// ===================================== Start to post data ===========================================
	// Post claim data to Patient History DB for updates
		function showError(message) {
            $('#info_form').hide()

            $('#main-container')
                .append("<label>"+message+"</label>");
        }


	$('#submitClaim').click(async(event) => {

		event.preventDefault();
		
		var AID = $('#aid').val();
		var Medication = $('#medication').val();
		var BillAmount = $('#bill_amt').val();
		var ClaimAmount = $('#claim_amt').val();
		
		var serviceURL_ph = "http://127.0.0.1:5008/patient_history/"+PID+"/";
		var mailURL = "http://localhost:5000/paymentemail"
		console.log(serviceURL_ph)
		
		var requestBody_ph = {
				AID:AID,
				Medication:Medication,
				BillAmount:BillAmount,
				ClaimAmount:ClaimAmount
			};

		try {
			const response = await fetch (serviceURL_ph,
				{
					method: 'POST',
					mode: 'cors',
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify (requestBody_ph)	
				}

				
			);
			console.log(response)
			console.log(requestBody_ph)

			console.log('1')

			const data = await response.json();
			console.log('2')
			console.log(data)

			if (!response.ok) {
				var msg = data['message'];
				showError(msg);
				console.log('3');

			} else {
				//send email about payment amt
				try {
					const mailresponse = await fetch (mailURL,
						{
							method: 'POST',
							headers: {"Content-Type": "application/json"},
							body: JSON.stringify (requestBody_ph)
						}					
					);
			
					const maildata = await mailresponse.json();

					if (!response.ok) {
						var msg = data['message'];
						showError(msg);
					} 
				} catch (error){
					console.log(error);
				} 
				location.replace("check_app.html");
				console.log('4')
			} 

		} catch (error) {
			console.log(error);
			showError ('There is a problem adding the appointment, please try again later.');
		}
	});

	//=================================Post to create claim===================================

	function showError(message) {
            $('#info_form').hide()

            $('#main-container')
                .append("<label>"+message+"</label>");
        }


	$('#submitClaim').click(async(event) => {

		event.preventDefault();
		
		var AID = $('#aid').val();
		// var ClaimID = $('#claim_id').val();
		var ClaimDate = $('#claim_date').val();
		var Medication = $('#medication').val();
		//var ClinicID = $('#clinic_id').val();
		// var PatientID = $('#patient_id').val();
		var ClaimStatus = $('#claim_status').val();
		var BillAmount = $('#bill_amt').val();
		var ClaimAmount = $('#claim_amt').val();
		
		var serviceURL_claim = "http://127.0.0.1:5003/claims/create/";

		console.log(serviceURL_claim)
		
		var requestBody_claim = {
			ClaimID:null,
			ClinicName:ClinicID,
			BillAmount:BillAmount,
			ClaimStatus:ClaimStatus,
			ClaimDate:ClaimDate,
			PatientID:PID,
			ClaimedAmount:ClaimAmount,
			RefundStatus: 'Pending',
			Medicine:Medication
		};

		try {
			const response = await fetch (serviceURL_claim,
				{
					method: 'POST',
					mode: 'cors',
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify (requestBody_claim)	
				}

				
			);
			console.log(response)
			console.log(requestBody_claim)

			console.log('1')

			const data = await response.json();
			console.log('2')
			console.log(data)

			if (!response.ok) {
				var msg = data['message'];
				showError(msg);
				console.log('3');

			} else {
				location.replace("check_app.html");
				console.log('4')
			} 

		} catch (error) {
			console.log(error);
			showError ('There is a problem adding the appointment, please try again later.');
		}
	});

</script>
</html>

